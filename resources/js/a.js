
// Ваш JSON-объект
// const data = {
//     "cellValue": {
//         "0": {
//             "0": {
//                 "s": "0",
//                 "p": {
//                     "id": "d",
//                     "documentStyle": {
//                         "pageSize": {
//                             "width": null,
//                             "height": null
//                         },
//                         "marginTop": 0,
//                         "marginBottom": 2,
//                         "marginRight": 2,
//                         "marginLeft": 2,
//                         "renderConfig": {
//                             "horizontalAlign": 2,
//                             "verticalAlign": 3,
//                             "centerAngle": 0,
//                             "vertexAngle": 0,
//                             "wrapStrategy": 3
//                         }
//                     },
//                     "body": {
//                         "dataStream": "вторник          30. 07\r\n",
//                         "textRuns": [
//                             {
//                                 "st": 7,
//                                 "ed": 17,
//                                 "ts": {
//                                     "fs": 14,
//                                     "bl": 1,
//                                     "ff": "\"Times New Roman\""
//                                 }
//                             }
//                         ],
//                         "paragraphs": [
//                             {
//                                 "startIndex": 23,
//                                 "paragraphStyle": {
//                                     "horizontalAlign": 2
//                                 }
//                             }
//                         ]
//                     },
//                     "drawings": {},
//                     "drawingsOrder": []
//                 },
//                 "v": "вторник          30. 07"
//             },
//             "1": {
//                 "s": "0"
//             },
//             "2": {
//                 "s": "0"
//             },
//             "3": {
//                 "s": "1",
//                 "p": {
//                     "id": "d",
//                     "documentStyle": {
//                         "pageSize": {
//                             "width": null,
//                             "height": null
//                         },
//                         "marginTop": 0,
//                         "marginBottom": 2,
//                         "marginRight": 2,
//                         "marginLeft": 2,
//                         "renderConfig": {
//                             "horizontalAlign": 0,
//                             "verticalAlign": 0,
//                             "centerAngle": 0,
//                             "vertexAngle": 0,
//                             "wrapStrategy": 0
//                         }
//                     },
//                     "body": {
//                         "dataStream": "среда          31. 07\r\n",
//                         "textRuns": [
//                             {
//                                 "st": 5,
//                                 "ed": 15,
//                                 "ts": {
//                                     "fs": 14,
//                                     "bl": 1,
//                                     "ff": "\"Times New Roman\""
//                                 }
//                             }
//                         ],
//                         "paragraphs": [
//                             {
//                                 "startIndex": 21
//                             }
//                         ]
//                     },
//                     "drawings": {},
//                     "drawingsOrder": []
//                 },
//                 "v": "среда          31. 07"
//             },
//             "4": {
//                 "s": "1"
//             },
//             "5": {
//                 "s": "1"
//             }
//         },
//         "1": {
//             "0": {
//                 "s": "2",
//                 "v": "МГС"
//             },
//             "1": {
//                 "s": "3",
//                 "v": "кострома- иваново"
//             },
//             "2": {
//                 "s": "4",
//                 "v": 101
//             },
//             "3": {
//                 "s": "5",
//                 "v": "МГС"
//             },
//             "4": {
//                 "s": "3",
//                 "v": "севмаш"
//             },
//             "5": {
//                 "s": "4",
//                 "p": {
//                     "id": "d",
//                     "documentStyle": {
//                         "pageSize": {
//                             "width": null,
//                             "height": null
//                         },
//                         "marginTop": 0,
//                         "marginBottom": 2,
//                         "marginRight": 2,
//                         "marginLeft": 2,
//                         "renderConfig": {
//                             "horizontalAlign": 0,
//                             "verticalAlign": 0,
//                             "centerAngle": 0,
//                             "vertexAngle": 0,
//                             "wrapStrategy": 0
//                         }
//                     },
//                     "body": {
//                         "dataStream": " 121\r\n",
//                         "textRuns": [
//                             {
//                                 "st": 0,
//                                 "ed": 1,
//                                 "ts": {
//                                     "cl": {
//                                         "rgb": "rgb(0,0,0)"
//                                     },
//                                     "fs": 14,
//                                     "ff": "\"Times New Roman\""
//                                 }
//                             }
//                         ],
//                         "paragraphs": [
//                             {
//                                 "startIndex": 4
//                             }
//                         ]
//                     },
//                     "drawings": {},
//                     "drawingsOrder": []
//                 },
//                 "v": " 121"
//             }
//         },
//         "2": {
//             "0": {
//                 "s": "2"
//             },
//             "1": {
//                 "s": "3"
//             },
//             "2": {
//                 "s": "6",
//                 "v": "яковлев"
//             },
//             "3": {
//                 "s": "5"
//             },
//             "4": {
//                 "s": "3"
//             },
//             "5": {
//                 "s": "7",
//                 "p": {
//                     "id": "d",
//                     "documentStyle": {
//                         "pageSize": {
//                             "width": null,
//                             "height": null
//                         },
//                         "marginTop": 0,
//                         "marginBottom": 2,
//                         "marginRight": 2,
//                         "marginLeft": 2,
//                         "renderConfig": {
//                             "horizontalAlign": 0,
//                             "verticalAlign": 0,
//                             "centerAngle": 0,
//                             "vertexAngle": 0,
//                             "wrapStrategy": 0
//                         }
//                     },
//                     "body": {
//                         "dataStream": " неелов\r\n",
//                         "textRuns": [
//                             {
//                                 "st": 0,
//                                 "ed": 1,
//                                 "ts": {
//                                     "cl": {
//                                         "rgb": "rgb(0,0,0)"
//                                     },
//                                     "fs": 14,
//                                     "ff": "\"Times New Roman\""
//                                 }
//                             }
//                         ],
//                         "paragraphs": [
//                             {
//                                 "startIndex": 7
//                             }
//                         ]
//                     },
//                     "drawings": {},
//                     "drawingsOrder": []
//                 },
//                 "v": " неелов"
//             }
//         },
//         "3": {
//             "0": {
//                 "s": "8",
//                 "v": "МГС"
//             },
//             "1": {
//                 "s": "9",
//                 "v": "балтика  ярославль"
//             },
//             "2": {
//                 "s": "7",
//                 "v": 69
//             },
//             "3": {
//                 "s": "10",
//                 "v": "МГС"
//             },
//             "4": {
//                 "s": "9",
//                 "v": "балтика  СПБ"
//             },
//             "5": {
//                 "s": "7",
//                 "v": 806
//             }
//         },
//         "4": {
//             "0": {
//                 "s": "8"
//             },
//             "1": {
//                 "s": "9"
//             },
//             "2": {
//                 "s": "6",
//                 "v": "иванов"
//             },
//             "3": {
//                 "s": "10"
//             },
//             "4": {
//                 "s": "9"
//             },
//             "5": {
//                 "s": "7",
//                 "p": {
//                     "id": "d",
//                     "documentStyle": {
//                         "pageSize": {
//                             "width": null,
//                             "height": null
//                         },
//                         "marginTop": 0,
//                         "marginBottom": 2,
//                         "marginRight": 2,
//                         "marginLeft": 2,
//                         "renderConfig": {
//                             "horizontalAlign": 0,
//                             "verticalAlign": 0,
//                             "centerAngle": 0,
//                             "vertexAngle": 0,
//                             "wrapStrategy": 0
//                         }
//                     },
//                     "body": {
//                         "dataStream": "бучков  дом \r\n",
//                         "textRuns": [
//                             {
//                                 "st": 11,
//                                 "ed": 12,
//                                 "ts": {
//                                     "cl": {
//                                         "rgb": "rgb(0,0,0)"
//                                     },
//                                     "fs": 14,
//                                     "ff": "\"Times New Roman\""
//                                 }
//                             }
//                         ],
//                         "paragraphs": [
//                             {
//                                 "startIndex": 12
//                             }
//                         ]
//                     },
//                     "drawings": {},
//                     "drawingsOrder": []
//                 },
//                 "v": "бучков  дом "
//             }
//         },
//         "5": {
//             "0": {
//                 "s": "8",
//                 "v": " "
//             },
//             "1": {
//                 "s": "9",
//                 "v": " "
//             },
//             "2": {
//                 "s": "7",
//                 "v": " "
//             },
//             "3": {
//                 "s": "10",
//                 "v": "ДРГБ  перев"
//             },
//             "4": {
//                 "s": "9",
//                 "p": {
//                     "id": "d",
//                     "documentStyle": {
//                         "pageSize": {
//                             "width": null,
//                             "height": null
//                         },
//                         "marginTop": 0,
//                         "marginBottom": 2,
//                         "marginRight": 2,
//                         "marginLeft": 2,
//                         "renderConfig": {
//                             "horizontalAlign": 0,
//                             "verticalAlign": 0,
//                             "centerAngle": 0,
//                             "vertexAngle": 0,
//                             "wrapStrategy": 0
//                         }
//                     },
//                     "body": {
//                         "dataStream": " Эр ликид Зеленоград перенес эрликид на курск  01/08\r\n",
//                         "textRuns": [
//                             {
//                                 "st": 0,
//                                 "ed": 1,
//                                 "ts": {
//                                     "cl": {
//                                         "rgb": "rgb(0,0,0)"
//                                     },
//                                     "fs": 14,
//                                     "ff": "\"Times New Roman\""
//                                 }
//                             }
//                         ],
//                         "paragraphs": [
//                             {
//                                 "startIndex": 52
//                             }
//                         ]
//                     },
//                     "drawings": {},
//                     "drawingsOrder": []
//                 },
//                 "v": " Эр ликид Зеленоград перенес эрликид на курск  01/08"
//             },
//             "5": {
//                 "s": "7",
//                 "v": 952
//             }
//         },
//         "6": {
//             "0": {
//                 "s": "8"
//             },
//             "1": {
//                 "s": "9"
//             },
//             "2": {
//                 "s": "7",
//                 "v": " "
//             },
//             "3": {
//                 "s": "10"
//             },
//             "4": {
//                 "s": "9"
//             },
//             "5": {
//                 "s": "7",
//                 "v": "михайлов"
//             }
//         },
//         "7": {
//             "0": {
//                 "s": "11",
//                 "v": "ДРГБ инерт"
//             },
//             "1": {
//                 "s": "12",
//                 "v": "деметра+дана"
//             },
//             "2": {
//                 "s": "6",
//                 "v": 23
//             },
//             "3": {
//                 "s": "10",
//                 "v": "ДРГ  инерт"
//             },
//             "4": {
//                 "s": "13",
//                 "v": "малаховка  перенос! дост с 31 на 1"
//             },
//             "5": {
//                 "s": "7",
//                 "v": 23
//             }
//         },
//         "8": {
//             "0": {
//                 "s": "11"
//             },
//             "1": {
//                 "s": "12"
//             },
//             "2": {
//                 "s": "6",
//                 "v": "жарков"
//             },
//             "3": {
//                 "s": "10"
//             },
//             "4": {
//                 "s": "13"
//             },
//             "5": {
//                 "s": "7",
//                 "p": {
//                     "id": "d",
//                     "documentStyle": {
//                         "pageSize": {
//                             "width": null,
//                             "height": null
//                         },
//                         "marginTop": 0,
//                         "marginBottom": 2,
//                         "marginRight": 2,
//                         "marginLeft": 2,
//                         "renderConfig": {
//                             "horizontalAlign": 0,
//                             "verticalAlign": 0,
//                             "centerAngle": 0,
//                             "vertexAngle": 0,
//                             "wrapStrategy": 0
//                         }
//                     },
//                     "body": {
//                         "dataStream": "жарков \r\n",
//                         "textRuns": [
//                             {
//                                 "st": 6,
//                                 "ed": 7,
//                                 "ts": {
//                                     "cl": {
//                                         "rgb": "rgb(0,0,0)"
//                                     },
//                                     "fs": 14,
//                                     "ff": "\"Times New Roman\""
//                                 }
//                             }
//                         ],
//                         "paragraphs": [
//                             {
//                                 "startIndex": 7
//                             }
//                         ]
//                     },
//                     "drawings": {},
//                     "drawingsOrder": []
//                 },
//                 "v": "жарков "
//             }
//         }
//     }
// };

const data = JSON.parse(localStorage.getItem("cellData"));
const driverData = JSON.parse(localStorage.getItem("drivers"));
const spisok = JSON.parse(localStorage.getItem("spisok"));

// console.log(data);
function getInfo(rowKey, colKey) {
    rowKey = parseInt(rowKey);
    colKey = parseInt(colKey);

    let trans = getCellData(rowKey + 1, colKey);
    let info = getCellData(rowKey + 1, colKey + 1);
    let nomer = getCellData(rowKey + 1, colKey + 2);
    let vod = getCellData(rowKey + 2, colKey + 2);

    // Применяем trim только если значение является строкой
    trans = typeof trans === 'string' ? trans.trim() : trans;
    info = typeof info === 'string' ? info.trim() : info;
    nomer = typeof nomer === 'string' ? nomer.trim() : nomer;
    vod = typeof vod === 'string' ? vod.trim() : vod;

    // let trans = data.cellValue[parseInt(rowKey) + 1][parseInt(colKey)]["v"];
    // let info = data.cellValue[parseInt(rowKey) + 1][parseInt(colKey) + 1]["v"];
    // let nomer = data.cellValue[parseInt(rowKey) + 1][parseInt(colKey) + 2]["v"];
    // let vod = data.cellValue[parseInt(rowKey) + 2][parseInt(colKey) + 2]["v"];

    let {fullName, phone} = getFullDriverName(vod);

    let carInfo = getCarInfo(nomer);

    return {
        trans,
        info,
        nomer,
        vod,
        fullName,
        rowKey,
        colKey,
        carInfo,
        phone
    }
}

function normalizeString(str) {
    return str.replace(/ё/g, 'е').toLowerCase().trim(); // Заменяем ё на е и приводим к нижнему регистру
}

function getFullDriverName(shortName) {
    // Применяем trim к сокращенному имени и разбиваем на слова
    shortName = normalizeString(shortName);
    const shortNameWords = shortName.split(/\s+/).filter(word => word !== ''); //

    for (const row of Object.values(driverData)) {
        if (row[0]) {
            const driverShortName = normalizeString(row[0].v); // Нормализуем сокращенное имя водителя
            const driverFullName = row[1].v; // Полное имя водителя
            const driverPhone = row[3] ? row[3].v : null; // Телефон водителя (если существует)
            // Проверяем, содержит ли сокращенное имя водителя хотя бы одно слово из shortName
            const anyWordMatch = shortNameWords.some(word => driverShortName.includes(word));

            if (anyWordMatch) {
                return { fullName: driverFullName, phone: driverPhone }; // Возвращаем полное имя и телефон
            }
        }
    }
    return { fullName: null, phone: null }; // Если не найдено
}

function getCarInfo(carCode) {
    for (const row of Object.values(spisok)) {
        if (row[0]) {
            const code = row[0].v; // Нормализуем код автомобиля
            if (code === carCode) {
                return {
                    model: row[1].v, // Модель авто
                    number: row[2].v, // Номер авто
                    trailerNumber: row[3] ? row[3].v : null, // Номер прицепа
                    trailerModel: row[4] ? row[4].v : null // Модель прицепа
                };
            }
        }
    }
    return { model: null, number: null, trailerNumber: null, trailerModel: null }; // Если не найдено
}

function getCellData(rowKey, colKey) {
    if (data[rowKey] && data[rowKey][colKey]) {
        return data[rowKey][colKey]["v"];
    }
}


document.getElementById('showTableButton').addEventListener('click', function() {
// Заданная дата для поиска
    console.log(1);

    const searchDate = "31. 07";


// const rows = Object.entries(data);
//
// // Используем метод find для поиска строки, содержащей искомую дату
// const foundRow = rows.find(([rowKey, rowValue]) => {
//     return Object.values(rowValue).some(colValue =>
//         colValue.v && typeof colValue.v === 'string' && colValue.v.includes(searchDate)
//     );
// });
//
// // Обработка найденной строки
// if (foundRow) {
//     const [rowKey, rowValue] = foundRow;
//     console.log(`Дата '${searchDate}' найдена в строке ${rowKey}`);
//
//     // Дополнительная обработка найденной строки
//     Object.entries(rowValue).forEach(([colKey, colValue]) => {
//         // Проверяем, существует ли colValue.v и является ли он строкой
//         if (colValue.v && typeof colValue.v === 'string' && colValue.v.includes(searchDate)) {
//             console.log(`Столбец ${colKey}: ${colValue.v}`);
//         }
//     });
// } else {
//     console.log(`Дата '${searchDate}' не найдена в таблице.`);
// }



// Флаг для проверки, найдена ли дата
    let dateFound = false;
    let groupedData = [];

    let foundData = [];
// Проходим по всем строкам и столбцам
    for (const rowKey in data) {
        const rowValue = data[rowKey];
        for (const colKey in rowValue) {
            // console.log(colKey);
            const colValue = rowValue[colKey];
            // Проверяем, есть ли значение и содержит ли оно искомую дату
            if (colValue.v && typeof colValue.v === 'string') {
                if (colValue.v.includes(searchDate)) {
                    for (let i = parseInt(rowKey); i <= parseInt(rowKey) + 20; i+=2)
                    {
                        const info = getInfo(i, colKey);
                        const transParts = info.trans.split(' ').map(part => part.trim()); // Разделяем и обрезаем пробелы
                        const transKey = transParts[0]; // Основное значение trans
                        const dopValue = transParts.slice(1).join(' '); // Дополнительное слово

                        // Добавляем поле dop в объект info
                        info.dop = dopValue.trim() || null; // Если дополнительное слово пустое, устанавливаем в null

                        if (
                            !(info.vod === "" || info.vod === null) &&
                            !(info.nomer === "" || info.nomer === null) &&
                            !(info.trans === "" || info.trans === null) &&
                            !(info.info === "" || info.info === null)
                        )
                        {
                            // Если ключ trans еще не существует в groupedData, создаем новый массив
                            if (!groupedData[transKey]) {
                                groupedData[transKey] = [];
                            }

                            // Добавляем информацию в соответствующий массив
                            groupedData[transKey].push(info);
                        }





                        // let foundArr = [];
                        // console.log(colKey);
                        // foundData.push(getInfo(i, colKey));
                        // foundArr[colValue.v] = {trans, info, nomer, vod};
                        // foundData.push({trans, info, nomer, vod});
                    }
                    console.log(`Дата '${searchDate}' найдена в строке ${rowKey}, столбце ${colKey}: ${colValue.v}`);
                    dateFound = true;
                    // console.log(foundData);
                }
            }
        }
    }

    console.log(groupedData);

// fetchData();

// Если дата не найдена
    if (!dateFound) {
        console.log(`Дата '${searchDate}' не найдена в таблице.`);
    }

// Массив для хранения строк таблицы
    const tableData = [];

// Проходим по каждому поставщику в groupedData
    for (const supplier in groupedData) {
        const records = groupedData[supplier];

        // Проходим по каждой записи для данного поставщика
        records.forEach(record => {
            // Создаем объект для строки таблицы
            const tableRow = {
                supplierName: supplier, // Название поставщика
                dop: record.dop,
                code: record.nomer, // Код
                info: record.info, // Марка а/м
                carNumber: record.carInfo.number, // Гос. номер а/м (можно изменить, если нужно)
                trailerModel: record.carInfo.trailerModel, // Прицеп (если есть, добавьте логику)
                trailerNumber: record.carInfo.trailerNumber, // Гос. номер прицепа (если есть, добавьте логику)
                tons: null, // Тонн (если есть, добавьте логику)
                driver: record.fullName, // Водитель
                phone: record.phone, // Телефон
                payer: null // ПЛАТЕЛЬЩИК (если есть, добавьте логику)
            };

            // Добавляем строку в массив таблицы
            tableData.push(tableRow);
        });
    }

// Выводим таблицу в консоль
    console.table(tableData);



    console.log(groupedData);
    // Сохраняем данные в localStorage
    localStorage.setItem('tablАeData', JSON.stringify(groupedData));
    // Перенаправляем на другую страницу
    // window.location.href = 'v.html';
});